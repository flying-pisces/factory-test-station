<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Test Station - Web Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f5f5f5; 
        }
        
        /* Header section - matching TK dark theme */
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }
        .header .subtitle {
            font-size: 11px;
        }
        
        /* Container */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 10px;
        }
        
        /* Serial number section - white with blue left border */
        .serial-section {
            background: white;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            overflow: hidden;
        }
        .serial-content {
            padding: 15px;
        }
        .serial-label {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .serial-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 10px;
            width: 250px;
        }
        
        /* Buttons - matching TK colors */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            font-size: 9px;
            cursor: pointer;
            font-family: Arial, sans-serif;
        }
        .btn-auto { background: #6c757d; color: white; }
        .btn-auto:hover { background: #5a6268; }
        .btn-start { background: #28a745; color: white; }
        .btn-start:hover { background: #218838; }
        .btn-start:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-clear { background: #dc3545; color: white; }
        .btn-clear:hover { background: #c82333; }
        
        /* Status section */
        .status-section {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        .status-ready { border-left-color: #28a745; }
        .status-testing { border-left-color: #ffc107; }
        .status-error { border-left-color: #dc3545; }
        
        /* Test results table section */
        .results-section {
            background: white;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #6f42c1;
        }
        .results-content {
            padding: 15px;
        }
        .section-title {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        /* Table - matching TK layout exactly */
        .test-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        .test-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            border: 1px solid #dee2e6;
            font-weight: bold;
        }
        .test-table td {
            padding: 8px;
            border: 1px solid #dee2e6;
        }
        .test-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        .test-table tbody tr:nth-child(odd) {
            background: white;
        }
        
        /* Column widths matching TK interface */
        .col-parameter { width: 200px; }
        .col-value { width: 120px; text-align: center; }
        .col-low-limit { width: 100px; text-align: center; }
        .col-high-limit { width: 100px; text-align: center; }
        .col-attachment { width: 100px; text-align: center; }
        
        /* Overall result display */
        .overall-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }
        .result-pass { background: #d4edda; color: #155724; }
        .result-fail { background: #f8d7da; color: #721c24; }
        .result-testing { background: #fff3cd; color: #856404; }
        
        /* Console log section */
        .console-section {
            background: white;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        .console-content {
            padding: 15px;
        }
        .console-log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        /* Loading indicator */
        #loading {
            display: none;
            color: #ffc107;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* Test value status indicators */
        .value-pass { color: #28a745; font-weight: bold; }
        .value-fail { color: #dc3545; font-weight: bold; }
        .value-testing { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Header matching TK interface -->
    <div class="header">
        <h1>project_station</h1>
        <div class="subtitle">Factory Test Station - Web Interface</div>
    </div>
    
    <div class="container">
        <!-- Serial number section -->
        <div class="serial-section">
            <div class="serial-content">
                <div class="serial-label">Device Serial Number</div>
                <div class="input-row">
                    <input type="text" id="serial_number" class="serial-input" 
                           placeholder="Enter serial number" onkeypress="if(event.key==='Enter') runTest()">
                    <button onclick="autoScan()" class="btn btn-auto">Auto Scan</button>
                    <button onclick="runTest()" id="runBtn" class="btn btn-start">Start Test</button>
                    <button onclick="clearResults()" class="btn btn-clear">Clear Results</button>
                </div>
                <div id="loading">‚è≥ Running test...</div>
            </div>
        </div>
        
        <!-- Status section -->
        <div class="status-section status-ready" id="statusSection">
            <div id="status">Loading...</div>
        </div>
        
        <!-- Test results table section -->
        <div class="results-section">
            <div class="results-content">
                <div class="section-title">Test Results</div>
                <table class="test-table">
                    <thead>
                        <tr>
                            <th class="col-parameter">Test Parameter</th>
                            <th class="col-value">Test Value</th>
                            <th class="col-low-limit">Low Limit</th>
                            <th class="col-high-limit">High Limit</th>
                            <th class="col-attachment">Attachment</th>
                        </tr>
                    </thead>
                    <tbody id="testTableBody">
                        {% for limit in station_limits %}
                        <tr data-test-name="{{ limit.name }}">
                            <td class="col-parameter">{{ limit.name }}</td>
                            <td class="col-value" id="value-{{ loop.index0 }}">‚Äî</td>
                            <td class="col-low-limit">
                                {% if limit.low_limit is not none and limit.low_limit != '' %}
                                    {{ limit.low_limit }}
                                {% endif %}
                            </td>
                            <td class="col-high-limit">
                                {% if limit.high_limit is not none and limit.high_limit != '' %}
                                    {{ limit.high_limit }}
                                {% endif %}
                            </td>
                            <td class="col-attachment">
                                {% if limit.low_limit is not none %}
                                    üìä
                                {% else %}
                                    üìã
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="overallResult" class="overall-result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Console log section -->
        <div class="console-section">
            <div class="console-content">
                <div class="section-title">Console Log</div>
                <div id="consoleLog" class="console-log"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Store station limits for reference
        let stationLimits = {{ station_limits | tojson }};
        let testValues = {};
        
        // Initialize test values
        stationLimits.forEach((limit, index) => {
            testValues[limit.name] = '‚Äî';
        });

        function loadStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ready') {
                        document.getElementById('status').innerHTML = `
                            ‚úÖ <strong>Station Ready</strong><br>
                            Station: ${data.station_type} #${data.station_number} | 
                            Active: ${data.is_active ? 'Yes' : 'No'} | 
                            Platform: ${data.platform} | 
                            Loaded ${data.station_limits.length} test items from configuration
                        `;
                        document.getElementById('statusSection').className = 'status-section status-ready';
                        
                        // Update test values if available
                        if (data.current_test_values) {
                            updateTestValues(data.current_test_values, 'ready');
                        }
                    } else {
                        document.getElementById('status').innerHTML = `
                            ‚ùå <strong>Station Error:</strong> ${data.error}
                        `;
                        document.getElementById('statusSection').className = 'status-section status-error';
                    }
                })
                .catch(error => {
                    document.getElementById('status').innerHTML = `
                        ‚ùå <strong>Connection Error:</strong> ${error.message}
                    `;
                    document.getElementById('statusSection').className = 'status-section status-error';
                });
        }

        function updateTestValues(values, status) {
            Object.keys(values).forEach((testName, index) => {
                const valueElement = document.getElementById(`value-${index}`);
                if (valueElement) {
                    valueElement.textContent = values[testName];
                    
                    // Apply styling based on value content
                    valueElement.className = 'col-value';
                    if (values[testName].startsWith('‚úì')) {
                        valueElement.classList.add('value-pass');
                    } else if (values[testName].startsWith('‚úó')) {
                        valueElement.classList.add('value-fail');
                    } else if (values[testName] === 'Testing...') {
                        valueElement.classList.add('value-testing');
                    }
                }
            });
            
            testValues = values;
        }

        function autoScan() {
            // Auto-generate a test serial number
            const timestamp = new Date().toISOString().slice(11, 19).replace(/:/g, '');
            const autoSerial = `AUTO${timestamp}`;
            document.getElementById('serial_number').value = autoSerial;
            addToConsole(`Auto-generated serial number: ${autoSerial}`, '#007bff');
        }

        function runTest() {
            const serialNumber = document.getElementById('serial_number').value.trim();
            if (!serialNumber) {
                alert('Please enter a serial number');
                return;
            }

            document.getElementById('runBtn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('statusSection').className = 'status-section status-testing';
            document.getElementById('status').innerHTML = `üîÑ <strong>Testing in progress...</strong> Unit: ${serialNumber}`;
            
            // Clear overall result
            document.getElementById('overallResult').style.display = 'none';

            fetch('/run_test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ serial_number: serialNumber })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('statusSection').className = 'status-section status-error';
                    document.getElementById('status').innerHTML = `‚ùå <strong>Test Error:</strong> ${data.error}`;
                } else {
                    // Test completed - final status will come via socket
                    addToConsole(`Test completed for ${serialNumber}: ${data.passed ? 'PASS' : 'FAIL'}`, data.passed ? '#28a745' : '#dc3545');
                    
                    // Show overall result
                    const resultDiv = document.getElementById('overallResult');
                    resultDiv.textContent = `Overall Result: ${data.passed ? 'PASS' : 'FAIL'}`;
                    resultDiv.className = `overall-result ${data.passed ? 'result-pass' : 'result-fail'}`;
                    resultDiv.style.display = 'block';
                    
                    document.getElementById('serial_number').value = '';
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
                document.getElementById('statusSection').className = 'status-section status-error';
                document.getElementById('status').innerHTML = `‚ùå <strong>Connection Error:</strong> ${error.message}`;
            })
            .finally(() => {
                document.getElementById('runBtn').disabled = false;
                document.getElementById('loading').style.display = 'none';
            });
        }

        function clearResults() {
            fetch('/clear_results', { method: 'POST' })
                .then(() => {
                    addToConsole('Results cleared', '#6c757d');
                    
                    // Hide overall result
                    document.getElementById('overallResult').style.display = 'none';
                    
                    // Reset status
                    document.getElementById('statusSection').className = 'status-section status-ready';
                    loadStatus();
                });
        }

        function addToConsole(message, color) {
            const consoleLog = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}
`;
            
            const span = document.createElement('span');
            span.style.color = color || '#000';
            span.textContent = logEntry;
            
            consoleLog.appendChild(span);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        // Socket.IO event handlers for real-time updates
        socket.on('test_values_update', function(data) {
            updateTestValues(data.test_values, data.status);
        });

        socket.on('test_complete', function(data) {
            updateTestValues(data.test_values, 'complete');
            
            if (data.result.passed) {
                document.getElementById('statusSection').className = 'status-section status-ready';
                document.getElementById('status').innerHTML = `‚úÖ <strong>Test Completed:</strong> ${data.result.serial_number} PASSED`;
            } else {
                document.getElementById('statusSection').className = 'status-section status-error';  
                document.getElementById('status').innerHTML = `‚ùå <strong>Test Completed:</strong> ${data.result.serial_number} FAILED`;
            }
        });

        // Initialize page
        loadStatus();
        
        // Add initial console messages
        addToConsole('[Ready] Factory Test Station Web Interface', '#ffffff');
        addToConsole(`[Ready] Platform: ${navigator.platform}`, '#ffffff');
        addToConsole(`[Ready] Loaded ${stationLimits.length} test items from configuration`, '#ffffff');
        addToConsole('[Ready] Enter serial number or use Auto Scan to start', '#ffffff');
        
        // Focus serial number input
        document.getElementById('serial_number').focus();
        
        // Refresh status every 30 seconds
        setInterval(loadStatus, 30000);
    </script>
</body>
</html>