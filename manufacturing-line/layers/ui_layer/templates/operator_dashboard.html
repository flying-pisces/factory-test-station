<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Line - Operator Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo h1 {
            color: #3498db;
            font-size: 1.8rem;
        }
        
        .status-info {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2ecc71;
        }
        
        .status-label {
            font-size: 0.9rem;
            color: #bdc3c7;
        }
        
        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .production-metrics {
            background: #2c3e50;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .metric-card {
            background: #34495e;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .metric-target {
            font-size: 0.9rem;
            color: #95a5a6;
        }
        
        .trend-up { color: #2ecc71; }
        .trend-down { color: #e74c3c; }
        .trend-stable { color: #f39c12; }
        
        .alerts-panel {
            background: #2c3e50;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .alert-item {
            background: #34495e;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-warning { border-left-color: #f39c12; }
        .alert-error { border-left-color: #e74c3c; }
        .alert-info { border-left-color: #3498db; }
        
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .equipment-card {
            background: #2c3e50;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 0.5rem;
        }
        
        .status-running { background-color: #2ecc71; }
        .status-stopped { background-color: #e74c3c; }
        .status-paused { background-color: #f39c12; }
        
        .equipment-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .equipment-metric {
            text-align: center;
        }
        
        .control-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .work-orders {
            background: #2c3e50;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .work-order-item {
            background: #34495e;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #95a5a6;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);
            transition: width 0.5s ease;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            margin: 1rem 0;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .equipment-grid {
                grid-template-columns: 1fr;
            }
            
            .status-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-content">
            <div class="logo">
                <h1>üè≠ Manufacturing Line Control</h1>
            </div>
            <div class="status-info">
                <div class="status-item">
                    <div class="status-value" id="system-status">ONLINE</div>
                    <div class="status-label">System Status</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="active-users">1</div>
                    <div class="status-label">Active Operators</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="current-time">--:--</div>
                    <div class="status-label">Current Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="dashboard-grid">
            <div class="production-metrics">
                <h2>Production Metrics</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Throughput</h3>
                        <div class="metric-value trend-stable" id="throughput-value">0</div>
                        <div class="metric-target">Target: <span id="throughput-target">100</span>/hr</div>
                    </div>
                    <div class="metric-card">
                        <h3>Efficiency</h3>
                        <div class="metric-value trend-up" id="efficiency-value">0%</div>
                        <div class="metric-target">Target: <span id="efficiency-target">90</span>%</div>
                    </div>
                    <div class="metric-card">
                        <h3>Quality Rate</h3>
                        <div class="metric-value trend-stable" id="quality-value">0%</div>
                        <div class="metric-target">Target: <span id="quality-target">99</span>%</div>
                    </div>
                    <div class="metric-card">
                        <h3>Uptime</h3>
                        <div class="metric-value trend-stable" id="uptime-value">0%</div>
                        <div class="metric-target">Target: <span id="uptime-target">95</span>%</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="production-chart"></canvas>
                </div>
            </div>

            <div class="alerts-panel">
                <h2>Active Alerts</h2>
                <div id="alerts-container">
                    <!-- Alerts will be populated dynamically -->
                </div>
            </div>
        </div>

        <div class="equipment-grid" id="equipment-grid">
            <!-- Equipment cards will be populated dynamically -->
        </div>

        <div class="work-orders">
            <h2>Work Orders</h2>
            <div id="work-orders-container">
                <!-- Work orders will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Chart variables
        let productionChart = null;
        const chartData = {
            throughput: [],
            efficiency: [],
            quality: [],
            timestamps: []
        };
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            initializeProductionChart();
        });
        
        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to dashboard server');
            document.getElementById('system-status').textContent = 'ONLINE';
            document.getElementById('system-status').style.color = '#2ecc71';
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from dashboard server');
            document.getElementById('system-status').textContent = 'OFFLINE';
            document.getElementById('system-status').style.color = '#e74c3c';
        });
        
        socket.on('dashboard_data', function(data) {
            updateDashboardData(data);
        });
        
        socket.on('dashboard_data_update', function(data) {
            updateProductionMetrics(data.production_metrics);
            updateEquipmentStatus(data.equipment_status);
            updateWorkOrders(data.work_orders);
            updateChart(data.production_metrics);
        });
        
        socket.on('new_alert', function(alert) {
            addAlert(alert);
        });
        
        socket.on('equipment_status_update', function(data) {
            updateEquipmentCard(data.equipment_id, data.status);
        });
        
        // Update functions
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }
        
        function updateDashboardData(data) {
            updateProductionMetrics(data.production_metrics);
            updateEquipmentStatus(data.equipment_status);
            updateAlerts(data.alerts);
            updateWorkOrders(data.work_orders);
        }
        
        function updateProductionMetrics(metrics) {
            document.getElementById('throughput-value').textContent = metrics.throughput.current;
            document.getElementById('efficiency-value').textContent = metrics.efficiency.current + '%';
            document.getElementById('quality-value').textContent = metrics.quality_rate.current + '%';
            document.getElementById('uptime-value').textContent = metrics.uptime.current + '%';
            
            // Update trend classes
            updateTrendClass('throughput-value', metrics.throughput.trend);
            updateTrendClass('efficiency-value', metrics.efficiency.trend);
            updateTrendClass('quality-value', metrics.quality_rate.trend);
            updateTrendClass('uptime-value', metrics.uptime.trend);
        }
        
        function updateTrendClass(elementId, trend) {
            const element = document.getElementById(elementId);
            element.className = element.className.replace(/trend-\w+/g, '');
            element.classList.add('trend-' + trend);
        }
        
        function updateEquipmentStatus(equipment) {
            const container = document.getElementById('equipment-grid');
            container.innerHTML = '';
            
            Object.values(equipment).forEach(eq => {
                const card = createEquipmentCard(eq);
                container.appendChild(card);
            });
        }
        
        function createEquipmentCard(equipment) {
            const card = document.createElement('div');
            card.className = 'equipment-card';
            card.innerHTML = `
                <div class="equipment-header">
                    <h3>${equipment.name}</h3>
                    <div class="status-indicator status-${equipment.status}"></div>
                </div>
                <div class="equipment-metrics">
                    <div class="equipment-metric">
                        <div style="font-size: 1.2rem; font-weight: bold;">${equipment.health_score.toFixed(1)}%</div>
                        <div style="font-size: 0.8rem; color: #95a5a6;">Health Score</div>
                    </div>
                    <div class="equipment-metric">
                        <div style="font-size: 1.2rem; font-weight: bold;">${equipment.temperature}¬∞C</div>
                        <div style="font-size: 0.8rem; color: #95a5a6;">Temperature</div>
                    </div>
                </div>
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="controlEquipment('${equipment.id}', 'start')">Start</button>
                    <button class="btn btn-warning" onclick="controlEquipment('${equipment.id}', 'pause')">Pause</button>
                    <button class="btn btn-danger" onclick="controlEquipment('${equipment.id}', 'stop')">Stop</button>
                    <button class="btn btn-primary" onclick="controlEquipment('${equipment.id}', 'reset')">Reset</button>
                </div>
            `;
            return card;
        }
        
        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            container.innerHTML = '';
            
            alerts.slice(0, 5).forEach(alert => {
                const alertElement = createAlertElement(alert);
                container.appendChild(alertElement);
            });
        }
        
        function addAlert(alert) {
            const container = document.getElementById('alerts-container');
            const alertElement = createAlertElement(alert);
            container.insertBefore(alertElement, container.firstChild);
            
            // Keep only 5 alerts visible
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }
        
        function createAlertElement(alert) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item alert-${alert.type}`;
            alertDiv.innerHTML = `
                <div>
                    <div style="font-weight: bold;">${alert.message}</div>
                    <div style="font-size: 0.8rem; color: #95a5a6;">${new Date(alert.timestamp).toLocaleTimeString()}</div>
                </div>
                <button class="btn btn-primary" onclick="acknowledgeAlert('${alert.id}')">
                    ${alert.acknowledged ? 'Acknowledged' : 'Acknowledge'}
                </button>
            `;
            return alertDiv;
        }
        
        function updateWorkOrders(workOrders) {
            const container = document.getElementById('work-orders-container');
            container.innerHTML = '';
            
            workOrders.forEach(wo => {
                const woElement = createWorkOrderElement(wo);
                container.appendChild(woElement);
            });
        }
        
        function createWorkOrderElement(workOrder) {
            const progress = (workOrder.completed / workOrder.quantity) * 100;
            const woDiv = document.createElement('div');
            woDiv.className = 'work-order-item';
            woDiv.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: bold;">${workOrder.id} - ${workOrder.product}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="font-size: 0.9rem; color: #95a5a6;">
                        ${workOrder.completed}/${workOrder.quantity} units (${progress.toFixed(1)}%)
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold; color: ${workOrder.priority === 'high' ? '#e74c3c' : '#f39c12'};">
                        ${workOrder.priority.toUpperCase()}
                    </div>
                    <div style="font-size: 0.8rem; color: #95a5a6;">
                        ${workOrder.line}
                    </div>
                </div>
            `;
            return woDiv;
        }
        
        // Chart functions
        function initializeProductionChart() {
            const ctx = document.getElementById('production-chart').getContext('2d');
            productionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.timestamps,
                    datasets: [
                        {
                            label: 'Throughput',
                            data: chartData.throughput,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Efficiency (%)',
                            data: chartData.efficiency,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#34495e' },
                            ticks: { color: '#ffffff' }
                        },
                        x: {
                            grid: { color: '#34495e' },
                            ticks: { color: '#ffffff' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }
        
        function updateChart(metrics) {
            const now = new Date().toLocaleTimeString();
            
            chartData.timestamps.push(now);
            chartData.throughput.push(metrics.throughput.current);
            chartData.efficiency.push(metrics.efficiency.current);
            
            // Keep only last 20 data points
            if (chartData.timestamps.length > 20) {
                chartData.timestamps.shift();
                chartData.throughput.shift();
                chartData.efficiency.shift();
            }
            
            productionChart.update();
        }
        
        // Control functions
        function controlEquipment(equipmentId, command) {
            socket.emit('equipment_command', {
                equipment_id: equipmentId,
                command: command,
                parameters: {}
            });
        }
        
        function acknowledgeAlert(alertId) {
            fetch(`/api/alerts/${alertId}/acknowledge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button
                    const alertElement = document.querySelector(`[onclick="acknowledgeAlert('${alertId}')"]`);
                    if (alertElement) {
                        alertElement.textContent = 'Acknowledged';
                        alertElement.disabled = true;
                    }
                }
            })
            .catch(error => console.error('Error acknowledging alert:', error));
        }
    </script>
</body>
</html>